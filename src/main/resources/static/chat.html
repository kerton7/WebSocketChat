<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="theme-color" content="#0b1220" />
    <title>C-420 Chat ‚Äî Oda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        :root{
            --bg:#050914; --panel:#0b1220; --card:#0f1724; --muted:#9aa4b2; --accent:#6b8cff; --accent-2:#6ee7b7;
            --danger:#ff6b6b; --success:#27ae60; --border:rgba(255,255,255,0.08);
        }
        html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:#e6eef6;}
        body{min-height:100vh;display:flex;flex-direction:column;}

        .app{display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(180deg,#05060a 0%, #071122 60%);padding:12px;gap:12px;}

        .topbar{
            display:flex;align-items:center;justify-content:space-between;
            background:var(--panel);border-radius:14px;padding:10px 12px;
            box-shadow:0 8px 30px rgba(0,0,0,0.35);
            position:sticky;top:0;z-index:20;
        }
        .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;color:var(--accent);}
        .brand small{color:var(--muted);font-weight:500;}
        .top-actions{display:flex;gap:8px;align-items:center;}
        .iconBtn{
            background:rgba(255,255,255,0.04);border:1px solid var(--border);color:#e6eef6;
            border-radius:10px;padding:10px;cursor:pointer;min-width:44px;min-height:44px;
            display:flex;align-items:center;justify-content:center;font-size:16px;
        }
        .iconBtn:active{transform:scale(0.97);}

        .layout{display:flex;gap:12px;}
        .main{
            flex:1;display:flex;flex-direction:column;gap:10px;
            background:var(--panel);border-radius:16px;padding:12px;
            box-shadow:0 8px 30px rgba(0,0,0,0.35);
        }
        .room-title{display:flex;justify-content:space-between;align-items:center;gap:8px;}
        .room-title h2{margin:0;font-size:18px;}
        .room-title .subtitle{color:var(--muted);font-size:13px;}

        .messages{
            background:var(--card);border-radius:14px;padding:12px;
            height:calc(100vh - 240px);overflow:auto;
            box-shadow:inset 0 1px 0 rgba(255,255,255,0.03);
        }
        .msgRow{display:flex;gap:10px;margin-bottom:12px;}
        .msgMeta{font-size:12px;color:var(--muted);min-width:70px;}
        .msgBubble{
            background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            padding:10px 12px;border-radius:12px;max-width:80%;
            word-break:break-word;
        }
        .compose{
            display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap;
        }
        .compose input[type="text"]{
            flex:1;min-width:180px;padding:14px;border-radius:12px;
            border:1px solid var(--border);background:rgba(255,255,255,0.02);
            color:inherit;font-size:15px;outline:none;
        }
        .compose button.primary{
            padding:14px 16px;border-radius:12px;border:none;background:var(--accent);
            color:#041029;font-weight:700;cursor:pointer;min-height:48px;flex-shrink:0;
        }
        .fileBtn{
            background:rgba(255,255,255,0.04);border:1px solid var(--border);
            color:#e6eef6;border-radius:12px;padding:14px;cursor:pointer;
            min-width:48px;min-height:48px;font-size:18px;display:flex;align-items:center;justify-content:center;
        }
        .fileInput{display:none;}
        .filePreview{
            display:none;gap:10px;align-items:center;padding:10px;
            background:rgba(255,255,255,0.05);border-radius:12px;font-size:13px;
            border:1px solid var(--border);
        }
        .filePreview img{max-width:72px;max-height:72px;border-radius:8px;object-fit:cover;}
        .removeFile{
            background:var(--danger);color:white;border:none;padding:8px 10px;border-radius:8px;
            cursor:pointer;font-size:12px;
        }

        /* Drawer */
        .drawer-overlay{
            position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(2px);
            display:none;z-index:40;
        }
        .drawer{
            position:fixed;top:0;left:0;height:100vh;width:320px;max-width:85vw;
            background:var(--panel);box-shadow:0 12px 40px rgba(0,0,0,0.55);
            transform:translateX(-100%);transition:transform 0.25s ease;z-index:50;
            display:flex;flex-direction:column;padding:14px 12px;gap:12px;
        }
        .drawer.open{transform:translateX(0);}
        .drawer-header{display:flex;justify-content:space-between;align-items:center;}
        .drawer h3{margin:0;font-size:16px;}
        .search{display:flex;gap:8px;}
        .search input{
            flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);
            background:rgba(255,255,255,0.02);color:inherit;
        }
        .userList,.dmList{overflow:auto;flex:1;padding-right:4px;}
        .userRow{
            display:flex;align-items:center;justify-content:space-between;
            padding:10px;border-radius:10px;cursor:pointer;
            background:rgba(255,255,255,0.02);margin-bottom:8px;
        }
        .username{font-weight:600;}
        .status{font-size:12px;color:var(--muted);}
        .pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.08);font-size:12px;color:var(--muted);}

        /* DM area */
        .dmCard{
            background:var(--card);padding:10px;border-radius:12px;display:flex;flex-direction:column;gap:8px;
            border:1px solid var(--border);
        }
        .dmConv{
            background:rgba(0,0,0,0.2);padding:10px;border-radius:10px;
            max-height:260px;overflow:auto;font-size:14px;
        }
        .dmCompose{
            display:flex;gap:8px;align-items:center;flex-wrap:wrap;
        }
        .dmCompose input{
            flex:1;min-width:160px;padding:12px;border-radius:10px;border:1px solid var(--border);
            background:rgba(255,255,255,0.03);color:inherit;
        }
        .dmCompose button{
            padding:12px;border-radius:10px;border:none;background:var(--accent-2);color:#041029;font-weight:700;cursor:pointer;min-height:44px;
        }

        /* Admin */
        .adminCard{
            background:var(--card);padding:10px;border-radius:12px;border:1px solid var(--border);
            max-height:40vh;overflow:auto;
        }
        .adminCard table{width:100%;border-collapse:collapse;font-size:13px;}
        .adminCard th, .adminCard td{padding:6px;border:1px solid var(--border);text-align:center;}
        .actionBtn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;}
        .actionBtn.ban{background:var(--danger);color:#fff;}
        .actionBtn.unban{background:var(--success);color:#041029;}

        /* Floating buttons */
        .fab{
            position:fixed;bottom:16px;right:16px;z-index:30;
            display:flex;gap:10px;flex-direction:column;
        }
        .fab button{
            border:none;border-radius:50%;width:56px;height:56px;font-size:20px;
            background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#041029;
            box-shadow:0 10px 30px rgba(0,0,0,0.45);cursor:pointer;
        }

        /* Mobile */
        @media (max-width:960px){
            .layout{flex-direction:column;}
            .messages{height:calc(100vh - 280px);}
        }
        @media (max-width:640px){
            .app{padding:8px;}
            .topbar{border-radius:12px;}
            .main{padding:10px;border-radius:14px;}
            .messages{height:calc(100vh - 260px);}
        }
    </style>
</head>
<body>
    <div class="drawer-overlay" id="drawerOverlay" onclick="toggleDrawer(false)"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <h3>Men√º</h3>
            <button class="iconBtn" onclick="toggleDrawer(false)">‚úï</button>
    </div>

        <div class="search">
            <input id="searchUsers" placeholder="Kullanƒ±cƒ± ara..." oninput="filterUsers()">
            <button class="iconBtn" onclick="role === 'ROLE_ADMIN' ? refreshUsers() : refreshActiveUsersDisplay()">‚ü≥</button>
        </div>

        <div class="pill" style="margin-top:6px;">Giri≈ü yapan: <strong id="meLabel"></strong></div>

        <h4 style="margin:10px 0 6px 0">Aktif Kullanƒ±cƒ±lar</h4>
        <div class="userList" id="userList"></div>

        <div class="dmCard">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>Direct Messages</strong>
                <div class="pill" id="dmStatus">No DM</div>
            </div>
            <div class="dmList" id="dmList"></div>
            <div class="dmConv" id="dmConv">Select a user to start private chat</div>
            <div class="dmCompose">
                <input type="file" id="dmFileInput" class="fileInput" accept="image/*,application/pdf,text/plain" onchange="handleDMFileSelect(event)">
                <button class="fileBtn" onclick="document.getElementById('dmFileInput').click()" title="Dosya/Fotoƒüraf Ekle" style="min-width:44px;min-height:44px;">üìé</button>
                <input id="dmInput" placeholder="Mesaj yaz...">
                <button id="dmSendBtn">G√∂nder</button>
            </div>
            <div id="dmFilePreview" class="filePreview" style="display:none"></div>
        </div>

        <div class="adminCard" id="adminCard" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>Admin Panel</strong>
                <div style="font-size:12px;color:var(--muted)">Kullanƒ±cƒ± y√∂netimi</div>
            </div>
            <div style="margin-top:8px;">
                <button class="iconBtn" style="width:100%;justify-content:center" onclick="loadUsers()">Yenile</button>
            </div>
            <div style="margin-top:8px;overflow:auto;max-height:260px;">
                <table id="adminTable">
                    <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Verified</th><th>Banned</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="app">
        <div class="topbar">
            <div class="brand">üî• C-420 Chat <small>Genel oda</small></div>
            <div class="top-actions">
                <button class="iconBtn" onclick="toggleDrawer(true)">‚ò∞</button>
                <button class="iconBtn" onclick="openAdmin()" id="adminToggle" style="display:none">Admin</button>
                <button class="iconBtn" onclick="logout()" title="√áƒ±kƒ±≈ü">üö™</button>
            </div>
        </div>

        <div class="layout">
            <div class="main">
                <div class="room-title">
                    <div>
                        <h2>C-420 Chat</h2>
                        <div class="subtitle">Herkesin katƒ±labildiƒüi genel oda</div>
                    </div>
                </div>

                <div class="messages" id="messages"></div>

                <div class="compose">
                    <input type="file" id="fileInput" class="fileInput" accept="image/*,application/pdf,text/plain" onchange="handleFileSelect(event)">
                    <button class="fileBtn" onclick="document.getElementById('fileInput').click()" title="Dosya/Fotoƒüraf Ekle">üìé</button>
                    <input id="msgInput" type="text" placeholder="Mesaj yaz..." onkeydown="if(event.key==='Enter') sendPublic()">
                    <button class="primary" onclick="sendPublic()">G√∂nder</button>
                </div>
                <div id="filePreview" class="filePreview"></div>
            </div>
        </div>
    </div>

    <div class="fab">
        <button onclick="toggleDrawer(true)" title="Kullanƒ±cƒ±lar">üë•</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
        const drawer = document.getElementById('drawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        function toggleDrawer(open){
            if(open){ drawer.classList.add('open'); drawerOverlay.style.display='block'; }
            else { drawer.classList.remove('open'); drawerOverlay.style.display='none'; }
        }

    // URL parametrelerinden token, username ve role'√º al (OAuth2 i√ßin)
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token');
    const urlUsername = urlParams.get('username');
    const urlRole = urlParams.get('role');
    if(urlToken && urlUsername){
        sessionStorage.setItem('token', urlToken);
        sessionStorage.setItem('username', urlUsername);
        sessionStorage.setItem('role', urlRole || 'ROLE_USER');
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    const token = sessionStorage.getItem('token');
    const me = sessionStorage.getItem('username');
    const role = sessionStorage.getItem('role') || 'ROLE_USER';
    const banned = sessionStorage.getItem('banned') === 'true';
        if(!token || !me){ alert('√ñnce giri≈ü yapƒ±n'); location.href='index.html'; }
        if(banned){ alert('Hesabƒ±nƒ±z yasaklƒ±!'); location.href='index.html'; }
    document.getElementById('meLabel').innerText = me;
        if(role === 'ROLE_ADMIN'){ document.getElementById('adminToggle').style.display='inline-flex'; }

    let stompClient = null;
    const usersCache = {};
    let activeDMUser = null;
    let activeUsersSet = new Set();
        connectWS();

    function connectWS(){
        const sock = new SockJS('/ws?token=' + encodeURIComponent(token));
        stompClient = Stomp.over(sock);
        stompClient.connect(
            { Authorization: 'Bearer ' + token },
            frame => {
                subscribeChannels();
                stompClient.send('/app/chat.addUser', {}, JSON.stringify({ sender: me, messageType: 'JOIN' }));
                loadPublicChatHistory();
            },
            err => console.error('WS error', err)
        );
    }

    async function loadPublicChatHistory(){
        try{
                const res = await fetch('/api/chat/history?limit=50', { headers: { 'Authorization': 'Bearer ' + token }});
            if(res.ok){
                const messages = await res.json();
                const box = document.getElementById('messages');
                box.innerHTML = '';
                    messages.reverse().forEach(m => { if(m.messageType === 'CHAT') appendPublicMessage(m); });
                }
            }catch(e){ console.warn('Failed to load chat history:', e); }
    }

    function subscribeChannels(){
        stompClient.subscribe('/topic/public', msg => { appendPublicMessage(JSON.parse(msg.body)); });
        stompClient.subscribe('/user/queue/private', msg => { appendDMMessage(JSON.parse(msg.body)); });
        stompClient.subscribe('/user/queue/errors', msg => { 
            const errorMsg = JSON.parse(msg.body);
            showErrorMessage(errorMsg.content || errorMsg.message || 'Bir hata olu≈ütu');
        });
        stompClient.subscribe('/topic/activeUsers', msg => { 
            const activeUsers = JSON.parse(msg.body);
            updateActiveUsersList(activeUsers);
        });
    }
    
    function showErrorMessage(message){
        alert(message);
        if(message.includes('yasaklandƒ±') || message.includes('banned')){
            sessionStorage.clear();
                setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        }
    }

    function el(tag,cls,txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!==undefined) e.innerText=txt; return e; }

    function appendPublicMessage(m){
        const box = document.getElementById('messages');
        const row = el('div','msgRow');
            const meta = el('div','msgMeta', (m.sender || 'system'));
        const bubble = el('div','msgBubble');
        let contentHtml = '';
        if (m.fileUrl) {
            if (m.fileType && m.fileType.startsWith('image/')) {
                    contentHtml += `<div style="margin-bottom:8px"><img src="${m.fileUrl}" alt="${escapeHtml(m.fileName || '')}" style="max-width:260px;max-height:260px;border-radius:10px;cursor:pointer" onclick="window.open('${m.fileUrl}', '_blank')"></div>`;
            } else {
                    contentHtml += `<div style="margin-bottom:8px;padding:8px;background:rgba(255,255,255,0.06);border-radius:8px"><a href="${m.fileUrl}" target="_blank" style="color:var(--accent);text-decoration:none">üìÑ ${escapeHtml(m.fileName || 'Dosya')}</a></div>`;
            }
        }
            if (m.content) { contentHtml += `<div style="font-size:14px;line-height:1.4">${escapeHtml(m.content)}</div>`; }
        bubble.innerHTML = contentHtml;
            row.appendChild(meta); row.appendChild(bubble);
            box.appendChild(row); box.scrollTop = box.scrollHeight;
    }

    function appendDMMessage(m){
        const isMine = m.sender === me;
        const conv = document.getElementById('dmConv');
            if(!activeDMUser){ document.getElementById('dmStatus').innerText = 'New DM from ' + m.sender; return; }
        if(activeDMUser === m.sender || activeDMUser === m.receiver || isMine){
                const b = el('div','msgBubble'); b.style.marginBottom='8px';
            b.style.background = isMine ? 'linear-gradient(90deg,#3dd9b6,#6b8cff)' : 'linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';
            let contentHtml = `<div style="font-size:13px"><strong>${escapeHtml(m.sender)}</strong></div>`;
            if (m.fileUrl) {
                if (m.fileType && m.fileType.startsWith('image/')) {
                    contentHtml += `<div style="margin-bottom:8px"><img src="${m.fileUrl}" alt="${escapeHtml(m.fileName || '')}" style="max-width:200px;max-height:200px;border-radius:6px;cursor:pointer" onclick="window.open('${m.fileUrl}', '_blank')"></div>`;
                } else {
                    contentHtml += `<div style="margin-bottom:8px;padding:6px;background:rgba(0,0,0,0.2);border-radius:4px"><a href="${m.fileUrl}" target="_blank" style="color:inherit;text-decoration:none">üìÑ ${escapeHtml(m.fileName || 'Dosya')}</a></div>`;
                }
            }
                if (m.content) { contentHtml += `<div>${escapeHtml(m.content)}</div>`; }
                b.innerHTML = contentHtml; conv.appendChild(b); conv.scrollTop = conv.scrollHeight;
        } else {
            document.getElementById('dmStatus').innerText = 'New DM from ' + m.sender;
        }
    }

    let selectedFile = null;
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
            if (file.size > 10 * 1024 * 1024) { alert('Dosya boyutu √ßok b√ºy√ºk. Maksimum 10MB.'); event.target.value = ''; return; }
            selectedFile = file; showFilePreview(file);
        }
    function showFilePreview(file) {
            const preview = document.getElementById('filePreview'); preview.style.display = 'flex';
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div style="flex:1">
                        <div style="font-weight:600">${escapeHtml(file.name)}</div>
                        <div style="color:var(--muted);font-size:11px">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="removeFile" onclick="removeFile()">‚úï</button>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:600">üìÑ ${escapeHtml(file.name)}</div>
                    <div style="color:var(--muted);font-size:11px">${(file.size / 1024).toFixed(2)} KB</div>
                </div>
                <button class="removeFile" onclick="removeFile()">‚úï</button>
            `;
        }
    }
    function removeFile() {
        selectedFile = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('filePreview').style.display = 'none';
    }

    async function sendPublic(){
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
            let fileUrl = null, fileName = null, fileType = null;
        if (selectedFile) {
            try {
                    const formData = new FormData(); formData.append('file', selectedFile);
                    const headers = { 'Authorization': 'Bearer ' + token };
                    const uploadRes = await fetch('/api/files/upload', { method: 'POST', headers, body: formData });
                    if (!uploadRes.ok) { const error = await uploadRes.text(); alert('Dosya y√ºkleme hatasƒ±: ' + error); return; }
                const uploadData = await uploadRes.json();
                    fileUrl = uploadData.fileUrl; fileName = uploadData.fileName; fileType = uploadData.fileType;
                } catch (e) { alert('Dosya y√ºklenirken hata: ' + e.message); return; }
            }
            if (!text && !fileUrl) return;
            const message = { sender: me, content: text || (fileUrl ? fileName : ''), messageType: 'CHAT', fileUrl, fileName, fileType };
            if (!stompClient) { alert('Baƒülantƒ± hatasƒ±. L√ºtfen yenileyin.'); return; }
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(message));
            input.value = ''; removeFile();
    }

    async function refreshUsers(){
            if(role !== 'ROLE_ADMIN') return;
            try{
                const res = await fetch('/auth/admin/users', { headers:{ 'Authorization': 'Bearer '+token,'Content-Type':'application/json' }});
                if(!res.ok) { const errorText = await res.text(); throw new Error(errorText || res.statusText); }
            const arr = await res.json();
                buildUserList(arr); buildAdminTable(arr);
            }catch(e){ alert('Admin panel y√ºklenemedi: ' + e.message); }
        }

        function updateActiveUsersList(activeUsersArray){ activeUsersSet = new Set(activeUsersArray); refreshActiveUsersDisplay(); }
    function refreshActiveUsersDisplay(){
            const ul = document.getElementById('userList'); ul.innerHTML = '';
        activeUsersSet.forEach(username => {
            if(username === me) return;
            const user = usersCache[username];
            const row = el('div','userRow');
            const left = el('div');
                const statusText = user ? `${user.verified? 'Verified' : 'Unverified'} ‚Ä¢ ${user.banned? 'Banned' : 'Active'}` : 'Active';
            left.innerHTML = `<div class="username">${escapeHtml(username)} <span style="color:var(--accent-2);font-size:10px">‚óè</span></div><div class="status">${statusText}</div>`;
            row.appendChild(left);
            const actions = el('div');
                const dmBtn = el('button','iconBtn','DM'); dmBtn.style.padding='8px'; dmBtn.onclick = ()=> openDM(username);
            actions.appendChild(dmBtn);
            row.appendChild(actions);
            ul.appendChild(row);
        });
        if(activeUsersSet.size <= 1){
                const info = el('div'); info.style.color = 'var(--muted)'; info.style.fontSize = '12px'; info.style.textAlign = 'center'; info.style.padding = '12px'; info.innerText = 'No other active users'; ul.appendChild(info);
            }
        }
        function filterUsers(){
            const term = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('#userList .userRow');
            rows.forEach(r=>{
                const name = r.querySelector('.username').innerText.toLowerCase();
                r.style.display = name.includes(term) ? '' : 'none';
            });
        }

        function buildUserList(arr){ arr.forEach(u=>{ usersCache[u.username]=u; }); refreshActiveUsersDisplay(); }

    async function openDM(username){
        activeDMUser = username;
        document.getElementById('dmStatus').innerText = 'DM: '+username;
            document.getElementById('dmConv').innerHTML = '<div style="color:var(--muted)">Y√ºkleniyor...</div>';
        try{
                const res = await fetch('/api/chat/dm/'+encodeURIComponent(username)+'?currentUser='+encodeURIComponent(me), { headers:{ 'Authorization': 'Bearer '+token }});
            if(res.ok){
                const msgs = await res.json();
                    const conv = document.getElementById('dmConv'); conv.innerHTML = '';
                    if(msgs.length === 0){ conv.innerHTML = '<div style="color:var(--muted);text-align:center;padding:14px">√ñnceki mesaj yok. Sohbete ba≈ülayƒ±n!</div>'; }
                    else { msgs.forEach(m=> appendDMMessage(m)); }
                } else { document.getElementById('dmConv').innerHTML = '<div style="color:var(--muted)">Mesajlar alƒ±namadƒ±</div>'; }
            }catch(e){ document.getElementById('dmConv').innerHTML = '<div style="color:var(--muted)">Mesajlar alƒ±namadƒ±</div>'; }
    }

    let selectedDMFile = null;
    function handleDMFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
            if (file.size > 10 * 1024 * 1024) { alert('Dosya boyutu √ßok b√ºy√ºk. Maksimum 10MB.'); event.target.value = ''; return; }
            selectedDMFile = file; showDMFilePreview(file);
        }
    function showDMFilePreview(file) {
            const preview = document.getElementById('dmFilePreview'); preview.style.display = 'flex';
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div style="flex:1">
                        <div style="font-weight:600">${escapeHtml(file.name)}</div>
                        <div style="color:var(--muted);font-size:11px">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="removeFile" onclick="removeDMFile()">‚úï</button>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:600">üìÑ ${escapeHtml(file.name)}</div>
                    <div style="color:var(--muted);font-size:11px">${(file.size / 1024).toFixed(2)} KB</div>
                </div>
                <button class="removeFile" onclick="removeDMFile()">‚úï</button>
            `;
        }
    }
    function removeDMFile() {
        selectedDMFile = null;
        document.getElementById('dmFileInput').value = '';
        document.getElementById('dmFilePreview').style.display = 'none';
    }

    async function sendDM(){
        const dmInput = document.getElementById('dmInput');
        const text = dmInput.value.trim();
            if(!activeDMUser) { alert('√ñnce kullanƒ±cƒ± se√ßin'); return; }
            let fileUrl = null, fileName = null, fileType = null;
        if (selectedDMFile) {
            try {
                    const formData = new FormData(); formData.append('file', selectedDMFile);
                    const headers = { 'Authorization': 'Bearer ' + token };
                    const uploadRes = await fetch('/api/files/upload', { method: 'POST', headers, body: formData });
                    if (!uploadRes.ok) { const error = await uploadRes.text(); alert('Dosya y√ºkleme hatasƒ±: ' + error); return; }
                const uploadData = await uploadRes.json();
                    fileUrl = uploadData.fileUrl; fileName = uploadData.fileName; fileType = uploadData.fileType;
                } catch (e) { alert('Dosya y√ºklenirken hata: ' + e.message); return; }
            }
            if (!text && !fileUrl) return;
            const payload = { sender: me, receiver: activeDMUser, content: text || (fileUrl ? fileName : ''), messageType: 'PRIVATE', fileUrl, fileName, fileType };
            if (!stompClient) { alert('Baƒülantƒ± hatasƒ±.'); return; }
            stompClient.send('/app/privatemessage', {}, JSON.stringify(payload));
            dmInput.value = ''; removeDMFile();
    }

    document.getElementById('dmInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendDM(); });
    document.getElementById('dmSendBtn').addEventListener('click', sendDM);

    function buildAdminTable(arr){
            const tbody = document.querySelector('#adminTable tbody'); tbody.innerHTML = '';
        arr.forEach(u=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.id}</td>
            <td>${escapeHtml(u.username)}</td>
            <td>${escapeHtml(u.email||'')}</td>
            <td>${u.verified? 'Yes':''}</td>
            <td>${u.banned? 'Yes':''}</td>
            <td>
                ${u.banned ? `<button class="actionBtn unban" onclick="adminUnban(${u.id})">Unban</button>`
                : `<button class="actionBtn ban" onclick="adminBan(${u.id})">Ban</button>`}
                    <button style="margin-left:6px" class="actionBtn" onclick="impersonate('${u.username}')">Impersonate</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }

    async function adminBan(id){
            const minutes = prompt('Ka√ß dakika ban? (0 = kalƒ±cƒ±)', '60'); if(minutes===null) return;
        const m = parseInt(minutes||'0',10);
        const url = `/auth/admin/ban/${id}` + (m>0? `?minutes=${m}` : '');
            const res = await fetch(url, { method:'POST', headers:{ 'Authorization':'Bearer '+token }}); if(res.ok){ alert('Banlandƒ±'); loadUsers(); } else alert('Ban ba≈üarƒ±sƒ±z');
    }
    async function adminUnban(id){
            const res = await fetch(`/auth/admin/unban/${id}`, { method:'POST', headers:{ 'Authorization':'Bearer '+token }}); if(res.ok){ alert('Ban kaldƒ±rƒ±ldƒ±'); loadUsers(); } else alert('Unban ba≈üarƒ±sƒ±z');
    }
    function impersonate(username){
            if(!confirm(username+' kullanƒ±cƒ±sƒ± olarak devam edilsin mi?')) return;
            sessionStorage.setItem('username', username); location.reload();
    }

    function openAdmin(){ 
            if(role !== 'ROLE_ADMIN'){ alert('Admin yetkiniz yok'); return; }
        document.getElementById('adminCard').style.display = 'block'; 
            toggleDrawer(true);
        refreshUsers();
    }
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
        async function loadUsers(){ if(role === 'ROLE_ADMIN'){ await refreshUsers(); } }

    async function logout(){
            if(!confirm('√áƒ±kƒ±≈ü yapƒ±lsƒ±n mƒ±?')) return;
            try{
                if(stompClient){ stompClient.disconnect(); }
                await fetch('/auth/logout/'+encodeURIComponent(me), { method:'POST', headers:{ 'Authorization': 'Bearer '+token }});
            }catch(e){ console.error('Logout error:', e); }
            sessionStorage.clear(); window.location.href = 'index.html';
        }

    if(role === 'ROLE_ADMIN'){
            refreshUsers().catch(err => console.warn('Admin preload failed:', err));
    }
</script>
</body>
</html>

